<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrawlBot - Công cụ thu thập dữ liệu sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            font-weight: 600;
            color: #0d6efd;
        }
        .form-container {
            padding: 20px 0;
        }
        .file-input-label {
            display: block;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .file-input-label:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .file-input-label span {
            display: block;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .alert {
            margin-top: 15px;
        }
        .steps {
            counter-reset: step;
            margin-bottom: 20px;
        }
        .step {
            position: relative;
            padding-left: 35px;
            margin-bottom: 15px;
        }
        .step:before {
            content: counter(step);
            counter-increment: step;
            position: absolute;
            left: 0;
            top: 0;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            text-align: center;
            line-height: 25px;
            font-size: 0.9rem;
        }
        .data-format {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .data-format h5 {
            margin-top: 0;
            color: #0d6efd;
        }
        .data-format code {
            display: block;
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 0.85rem;
        }
        /* Thêm style cho progress bar */
        .progress-container {
            display: none;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .progress {
            height: 25px;
        }
        .progress-bar {
            line-height: 25px;
            font-size: 14px;
            font-weight: bold;
        }
        #progress-message {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <h1 class="text-center mb-4">CrawlBot</h1>
        <h5 class="text-center text-muted mb-4">Công cụ thu thập dữ liệu sản phẩm từ website</h5>

        {% if error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
        {% endif %}

        <!-- Thanh tiến trình -->
        <div id="progress-container" class="progress-container">
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div id="progress-message">Đang chuẩn bị...</div>
        </div>

        {% if download_url %}
        <div class="alert alert-success mb-4">
            Thu thập dữ liệu thành công! <a href="{{ download_url }}" class="alert-link">Tải xuống kết quả</a>
        </div>
        {% endif %}

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="extract-tab" data-bs-toggle="tab" data-bs-target="#extract" type="button" role="tab" aria-controls="extract" aria-selected="true">
                    1. Thu thập liên kết sản phẩm
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scrape-tab" data-bs-toggle="tab" data-bs-target="#scrape" type="button" role="tab" aria-controls="scrape" aria-selected="false">
                    2. Thu thập thông tin sản phẩm
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Tab thu thập liên kết sản phẩm -->
            <div class="tab-pane fade show active" id="extract" role="tabpanel" aria-labelledby="extract-tab">
                <div class="form-container">
                    <h4 class="mb-3">Thu thập liên kết sản phẩm từ danh mục</h4>
                    
                    <div class="steps">
                        <div class="step">
                            <p>Tạo một file <strong>TXT</strong> chứa danh sách các đường link danh mục sản phẩm (mỗi link trên một dòng)</p>
                        </div>
                        <div class="step">
                            <p>Tải file TXT lên hệ thống</p>
                        </div>
                        <div class="step">
                            <p>Nhấn nút "Thu thập liên kết" để bắt đầu quá trình thu thập</p>
                        </div>
                    </div>

                    <form action="/extract-links" method="post" enctype="multipart/form-data" id="extract-form">
                        <label for="link_file" class="file-input-label">
                            <i class="bi bi-cloud-upload fs-3"></i>
                            <div class="mt-2">Kéo thả hoặc chọn file TXT chứa danh sách liên kết danh mục</div>
                            <span>Chỉ chấp nhận file .txt</span>
                            <input type="file" id="link_file" name="link_file" class="d-none" accept=".txt">
                        </label>
                        <div id="link_file_name" class="mb-3 text-muted"></div>
                        <button type="submit" class="btn btn-primary w-100">Thu thập liên kết sản phẩm</button>
                    </form>
                </div>
            </div>

            <!-- Tab thu thập thông tin sản phẩm -->
            <div class="tab-pane fade" id="scrape" role="tabpanel" aria-labelledby="scrape-tab">
                <div class="form-container">
                    <h4 class="mb-3">Thu thập thông tin sản phẩm từ liên kết</h4>
                    
                    <div class="data-format">
                        <h5>Thông tin được trích xuất</h5>
                        <p>Hệ thống sẽ tự động trích xuất các thông tin sau:</p>
                        <ol>
                            <li><strong>STT</strong>: Số thứ tự tự động tăng</li>
                            <li><strong>Mã sản phẩm</strong>: Mã được lấy từ các thẻ có class như "product__symbol__value", "sku", v.v.</li>
                            <li><strong>Tên sản phẩm</strong>: Tên được lấy từ thẻ h1 có class như "product__name", v.v.</li>
                            <li><strong>Tổng quan</strong>: Bảng thông số kỹ thuật được định dạng HTML</li>
                        </ol>
                    </div>
                    
                    <div class="steps">
                        <div class="step">
                            <p>Tải lên file <strong>TXT</strong> chứa danh sách các đường link sản phẩm (kết quả từ bước 1 hoặc file tự tạo, mỗi link trên một dòng)</p>
                        </div>
                        <div class="step">
                            <p>Tải lên file <strong>Excel</strong> mẫu chứa tiêu đề các cột thông tin cần thu thập</p>
                        </div>
                        <div class="step">
                            <p>Nhấn nút "Thu thập thông tin" để bắt đầu quá trình thu thập</p>
                        </div>
                    </div>

                    <form action="/scrape-products" method="post" enctype="multipart/form-data" id="scrape-form">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="product_link_file" class="file-input-label">
                                    <i class="bi bi-link-45deg fs-3"></i>
                                    <div class="mt-2">File TXT chứa danh sách liên kết sản phẩm</div>
                                    <span>Chỉ chấp nhận file .txt</span>
                                    <input type="file" id="product_link_file" name="product_link_file" class="d-none" accept=".txt">
                                </label>
                                <div id="product_link_file_name" class="mb-3 text-muted"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="excel_template" class="file-input-label">
                                    <i class="bi bi-file-earmark-excel fs-3"></i>
                                    <div class="mt-2">File Excel mẫu chứa tiêu đề các cột thông tin</div>
                                    <span>Chỉ chấp nhận file .xlsx, .xls</span>
                                    <input type="file" id="excel_template" name="excel_template" class="d-none" accept=".xlsx, .xls">
                                </label>
                                <div id="excel_template_name" class="mb-3 text-muted"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Thu thập thông tin sản phẩm</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Thêm thư viện SocketIO -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        // Kết nối Socket.IO
        const socket = io();
        
        // Lắng nghe sự kiện cập nhật tiến trình
        socket.on('progress_update', function(data) {
            // Hiển thị thanh tiến trình
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            // Cập nhật giá trị thanh tiến trình
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = data.percent + '%';
            progressBar.setAttribute('aria-valuenow', data.percent);
            progressBar.innerText = data.percent + '%';
            
            // Cập nhật thông báo
            const progressMessage = document.getElementById('progress-message');
            progressMessage.innerText = data.message;
            
            // Nếu hoàn thành, tự động tải xuống kết quả
            if (data.percent === 100) {
                setTimeout(function() {
                    // Ẩn thanh tiến trình sau 3 giây
                    setTimeout(function() {
                        progressContainer.style.display = 'none';
                    }, 3000);
                }, 1000);
            }
        });

        // Hiển thị tên file khi người dùng chọn file
        document.getElementById('link_file').addEventListener('change', function(e) {
            if (this.files.length > 0) {
                document.getElementById('link_file_name').textContent = 'File đã chọn: ' + this.files[0].name;
            }
        });

        document.getElementById('product_link_file').addEventListener('change', function(e) {
            if (this.files.length > 0) {
                document.getElementById('product_link_file_name').textContent = 'File đã chọn: ' + this.files[0].name;
            }
        });

        document.getElementById('excel_template').addEventListener('change', function(e) {
            if (this.files.length > 0) {
                document.getElementById('excel_template_name').textContent = 'File đã chọn: ' + this.files[0].name;
            }
        });
        
        // Hiển thị thanh tiến trình khi gửi form
        document.getElementById('extract-form').addEventListener('submit', function(e) {
            const fileInput = document.getElementById('link_file');
            if (fileInput.files.length > 0) {
                const progressContainer = document.getElementById('progress-container');
                progressContainer.style.display = 'block';
                const progressMessage = document.getElementById('progress-message');
                progressMessage.innerText = 'Đang tải file lên...';
            }
        });
        
        document.getElementById('scrape-form').addEventListener('submit', function(e) {
            const linkFile = document.getElementById('product_link_file');
            const excelFile = document.getElementById('excel_template');
            if (linkFile.files.length > 0 && excelFile.files.length > 0) {
                const progressContainer = document.getElementById('progress-container');
                progressContainer.style.display = 'block';
                const progressMessage = document.getElementById('progress-message');
                progressMessage.innerText = 'Đang tải file lên...';
            }
        });
    </script>
</body>
</html> 